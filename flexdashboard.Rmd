---
title: "Champions League Progression"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    theme: 
      version: 5
      bootswatch: lux
---


```{r, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(stringr)
library(rvest)
library(httr)
library(ggplot2)
library(readr)
library(plotly)
library(flexdashboard)
library(ggthemes)
library(shinyWidgets)
library(reshape2)
library(gt)
```

```{r, echo = FALSE}
gs <- read_csv("gs.csv")
ps <- read_csv("ps.csv")
ds <- read_csv("ds.csv")
total_s <- read_csv("total_s.csv")
```

About
==========================

Column {data-width = 400}
-------------------------

#### Background Information

In this Shiny app, we investigate many of the subtle variables of that affect the outcome of a soccer game. Using the UFEA Champions League statistics from the 2018-2023 seasons, we compare certain variables in different game situations throughout time.

Data source:  [FBREF Database](https://fbref.com/en/comps/8/history/Champions-League-Seasons)

[UFEA Champions League Official Website](https://www.uefa.com/uefachampionsleague/)

If you would like to access the source code for this project, follow [this link](https://github.com/starce1/Champions-League-NS-EA) and click the download button and open the documents in a folder in R Studio.

Column
---------------------------

```{r, echo=FALSE}

renderImage({
    # Return a list
    list(src = "UEFA_Champions_League.svg.png",
         alt = "This is alternate text", width = 600, height = 600)
  })
```

Goals
=========================

Column
---------------------------

```{r, echo = FALSE}
titlePanel("Goal Metrics") 

inputPanel(
  selectInput("y", label = "Y-Axis Variable",
              choices = c(
                          "Expected Goals" = "xG",
                          "Non-Penalty Expected Goals" = "npxG",
                          "Average Shot Distance" = "Dist",
                          "Shots per 90 Minutes" = "Sh/90",
                          "Shot on Target %" = "SoT%", 
                          "Shot Creating Actions per 90 Minutes" = "SCA90",
                          "Proportion of Shot Creating Actions from Dead Balls" = "prop_SCA_dead")),
  selectInput("d", label = "Year",
  choices = c("All Years", unique(gs$Year))),
checkboxInput("rank_pos", "Show Final Placement", value = FALSE)
)

legend_order <- c("W", "F", "SF", "QF", "R16", "GR")

gs$Rank <- factor(gs$Rank, levels = legend_order)

  renderPlotly({
   if (input$rank_pos) 
    if (input$d == "All Years")
    gs |>
  plot_ly(x = ~Gls, y = ~.data[[input$y]], type = 'scatter', mode = 'markers', color = ~ Rank, text = ~paste("Team: ", Squad, '<br>Year: ', Year), height = 440) |>
      layout(xaxis = list(title = "Goals"),
             yaxis = list(title = if (input$y == "xG")
                                     "Expected Goals"
                                  else if (input$y == "npxG")
                                     "Non-Penalty Expected Goals"
                                  else if (input$y == "Dist")
                                     "Average Shot Distance"
                                  else if (input$y == "Sh/90")
                                     "Shots per 90 Minutes"
                                  else if (input$y == "SoT%")
                                     "Shot on Target %"
                                  else if (input$y == "SCA90")
                                     "Shot Creating Actions per 90 Minutes"
                                  else if (input$y == "prop_SCA_dead")
                                     "Proportion of Shot Creating Actions from Dead Balls"
                                  ), title = "Effect of Goal Creation Statistics on Goals Scored")
    else 
       gs |>
    filter(Year %in% c(input$d)) |>
   plot_ly(x = ~Gls, y = ~.data[[input$y]], type = 'scatter', mode = 'markers', color = ~ Rank, text = ~paste("Team: ", Squad, '<br>Year: ', Year), height = 440) |>
      layout(xaxis = list(title = "Goals"),
             yaxis = list(title = if (input$y == "xG")
                                     "Expected Goals"
                                  else if (input$y == "npxG")
                                     "Non-Penalty Expected Goals"
                                  else if (input$y == "Dist")
                                     "Average Shot Distance"
                                  else if (input$y == "Sh/90")
                                     "Shots per 90 Minutes"
                                  else if (input$y == "SoT%")
                                     "Shot on Target %"
                                  else if (input$y == "SCA90")
                                     "Shot Creating Actions per 90 Minutes"
                                  else if (input$y == "prop_SCA_dead")
                                     "Proportion of Shot Creating Actions from Dead Balls"
                                  ), title = "Effect of Goal Creation Statistics on Goals Scored")
  else if (!input$rank_pos)
    if (input$d == "All Years")
    gs |>
       plot_ly(x = ~Gls, y = ~.data[[input$y]], type = 'scatter', mode = 'markers', text = ~paste("Team: ", Squad, '<br>Year: ', Year), height = 440) |>
      layout(xaxis = list(title = "Goals"),
             yaxis = list(title = if (input$y == "xG")
                                     "Expected Goals"
                                  else if (input$y == "npxG")
                                     "Non-Penalty Expected Goals"
                                  else if (input$y == "Dist")
                                     "Average Shot Distance"
                                  else if (input$y == "Sh/90")
                                     "Shots per 90 Minutes"
                                  else if (input$y == "SoT%")
                                     "Shot on Target %"
                                  else if (input$y == "SCA90")
                                     "Shot Creating Actions per 90 Minutes"
                                  else if (input$y == "prop_SCA_dead")
                                     "Proportion of Shot Creating Actions from Dead Balls"
                                  ), title = "Effect of Goal Creation Statistics on Goals Scored")
    else 
       gs |>
    filter(Year %in% c(input$d)) |>
       plot_ly(x = ~Gls, y = ~.data[[input$y]], type = 'scatter', mode = 'markers', text = ~paste("Team: ", Squad, '<br>Year: ', Year), height = 440) |>
      layout(xaxis = list(title = "Goals"),
             yaxis = list(title = if (input$y == "xG")
                                     "Expected Goals"
                                  else if (input$y == "npxG")
                                     "Non-Penalty Expected Goals"
                                  else if (input$y == "Dist")
                                     "Average Shot Distance"
                                  else if (input$y == "Sh/90")
                                     "Shots per 90 Minutes"
                                  else if (input$y == "SoT%")
                                     "Shot on Target %"
                                  else if (input$y == "SCA90")
                                     "Shot Creating Actions per 90 Minutes"
                                  else if (input$y == "prop_SCA_dead")
                                     "Proportion of Shot Creating Actions from Dead Balls"
                                  ), title = "Effect of Goal Creation Statistics on Goals Scored")
})
```

```{r, echo = FALSE}
inputPanel(
  selectInput("year3", label = "Year",
    choices = c("All Years", unique(gs$Year))),
)

renderPlot({
  if (input$year3 == "All Years")
gs |>
ggplot() +
  geom_bar(aes(x = Rank, fill = performance)) +
  scale_x_discrete(limits = c("W", "F", "SF", "QF", "R16", "GR")) +
  labs(y = "Count", fill = "Goal Performance", title = "Does Goal Performance Influence Placement?") +
    theme_minimal()
  else 
  gs |>
    filter(Year %in% c(input$year3)) |>
ggplot() +
  geom_bar(aes(x = Rank, fill = performance)) +
  scale_x_discrete(limits = c("W", "F", "SF", "QF", "R16", "GR")) +
  labs(y = "Count", fill = "Goal Performance", title = "Does Goal Performance Influence Placement") +
    theme_clean()
})
```

Column
---------------------------

```{r, echo = FALSE}
inputPanel(
  selectInput("y3", label = "Y-Axis Variable",
              choices = c(
                          "Expected Goals" = "xG",
                          "Goals" = "Gls",
                          "Non-Penalty Expected Goals" = "npxG",
                          "Average Shot Distance" = "Dist",
                          "Shots per 90 Minutes" = "Sh/90",
                          "Shot on Target %" = "SoT%", 
                          "Shot Creation Actions per 90 Minutes" = "SCA90",
                          "Proportion of Shot Creating Actions from Dead Balls" = "prop_SCA_dead",
                          "Goals per Shot on Target" = "G/SoT", 
                          "Goals Minus Expected Goals" = "G-xG"))
)

renderPlot({
  ggplot(gs, aes(x = Rank, y = .data[[input$y3]])) +
    geom_boxplot() +
    scale_x_discrete(limits = c("GR", "R16", "QF", "SF", "F", "W")) +
    labs(y = switch(input$y3,
                    "xG" = "Expected Goals",
                    "Gls" = "Goals",
                    "npxG" = "Non-Penalty Expected Goals",
                    "Dist" = "Average Shot Distance",
                    "Sh/90" = "Shots per 90 Minutes",
                    "SoT%" = "Shot on Target %",
                    "SCA90" = "Shot Creating Actions per 90 Minutes",
                    "prop_SCA_dead" = "Proportion of Shot Creating Actions from Dead Balls",
                    "G/SoT" = "Goals per Shot on Target", 
                    "G-xG" = "Goals Minus Expected Goals"), title = "Goal Creation Statistical Averages by Champions League Placement") +
    theme_clean()
},
height = 400)
```

*Commentary:*

Typically, you'd think that goal and shooting metrics would have positive correlation with team rank (as the rank increases toward the winner), and for most of these metrics, it seems that this is exactly the case we have. It is interesting to see that these shooting metrics are correlated with these team ranking in an almost identical way they are correlated to goals made which makes since since you'd expect the better teams to score more goals especially since they had made it further in the champions league. The shooting metrics that don't seem to change much when the team ranking gets better also interestingly seems to be basically uncorrelated on the scatterplot where these metrics are plotted against goals. We didn't do any statistical analysis, but we're pretty confident in saying that the number goals made might effect these shooting statistics in a very similar way that team rank does. With those ideas in mind, we then decided to see whether all the teams that have competed in the champions league the past five years have under or overperformed on goals made based on their expected number of goals to score. There isn't much to note except that in particular, teams that only made it to the group stage usually underperformed on goals scored which makes sense. Finally, we decided to see whether the majority of teams over or under performed in each of the past five years. We can decide whether a team did or did not overperform based on whether the center (or highest point) on the density plot is a positive or negative value. It seems that the past two years teams have overperformed a bit more since they scored more goals then expected while the three years before that the opposite case occurred.


```{r, echo = FALSE}
inputPanel(
  selectInput("yr", "Year",
choices = c("All Years", unique(gs$Year))),
checkboxInput("penalty", "Include Penalty Shots", value = FALSE)
)

renderPlot({
  if(!input$penalty)
    if (input$yr == "All Years")
      gs |>
      ggplot(aes(x = `np:G-xG`)) +
      geom_density() +
      labs(x = "Non-Penalty Goals minus Non-Penalty Expected Goals", y = "Proportion of Teams", title = "Distribution of Goals Minus Expected Goals Values (Penalty and non-Penalty)") +
    theme_clean()
    else
      gs |>
        filter(Year %in% c(input$yr)) |>
        ggplot(aes(x = `np:G-xG`)) +
        geom_density() +
        labs(x = "Non-Penalty Goals minus Non-Penalty Expected Goals", y = "Proportion of Teams", title = "Distribution of Goals Minus Expected Goals Values (Penalty and non-Penalty)") +
    theme_clean()
  else
    if (input$yr == "All Years")
      gs |>
      ggplot(aes(x = `G-xG`)) +
      geom_density() +
        labs(x = "Goals minus Expected Goals", y = "Proportion of Teams", title = "Distribution of Goals Minus Expected Goals Values (Penalty and non-Penalty)") +
    theme_clean()
    else
      gs |>
        filter(Year %in% c(input$yr)) |>
        ggplot(aes(x = `G-xG`)) +
        geom_density() +
        labs(x = "Goals minus Expected Goals", y = "Proportion of Teams", title = "Distribution of Goals Minus Expected Goals Values (Penalty and non-Penalty)") +
    theme_clean()
})
```

Possession
=========================

Column
---------------------------

```{r, echo = FALSE}
titlePanel("Possession and Passing Metrics") 
inputPanel(
  selectInput("y2", label = "Y-Axis Variable",
              choices = c(
                          "Take-Ons Attempted" = "Att.x",
                          "Expected Assists" = "xA",
                          "Progressive Passes" = "PrgP",
                          "Touches in Defensive Third" = "Def 3rd", 
                          "Touches in Midfield Third" = "Mid 3rd",
                          "Touches in Attacking Third" = "Att 3rd",
                          "Proption of Touches in Defensive Third" = "prop_def_third",
                          "Proportion of Touches in Midfield Third" = "prop_mid_third",
                          "Proportion of Touches in Attacking Third" = "prop_att_third")),
  selectInput("d1", label = "Year",
  choices = c("All Years", unique(ps$Year))),
checkboxInput("rank_pos1", "Show Final Placement", value = FALSE)
)

ps$Rank <- factor(ps$Rank, levels = legend_order)

renderPlotly({
   if (input$rank_pos1) 
    if (input$d1 == "All Years")
    ps |>
  plot_ly(x = ~Poss, y = ~.data[[input$y2]], type = 'scatter', mode = 'markers', color = ~ Rank, text = ~paste("Team: ", Squad, '<br>Year: ', Year),
          height = 400) |>
      layout(xaxis = list(title = "Possession"),
             yaxis = list(title = if (input$y2 == "Att.x")
                                     "Take-Ons Attempted"
                                  else if (input$y2 == "xA")
                                     "Expected Assists"
                                  else if (input$y2 == "PrgP")
                                     "Progressive Passes"
                                  else if (input$y2 == "Def 3rd")
                                     "Touches in Defensive Third"
                                  else if (input$y2 == "Mid 3rd")
                                     "Touches in Midfield Third"
                                  else if (input$y2 == "Att 3rd")
                                     "Touches in Attacking Third"
                                  else if (input$y2 == "prop_def_third")
                                     "Proption of Touches in Defensive Third"
                                  else if (input$y2 == "prop_mid_third")
                                     "Proportion of Touches in Midfield Third"
                                  else if (input$y2 == "prop_att_third")
                                     "Proportion of Touches in Attacking Third"
                                  ), title = "Effect of Passing and Possession Statistics on Average Possession")
    else 
       ps |>
    filter(Year %in% c(input$d1)) |>
   plot_ly(x = ~Poss, y = ~.data[[input$y2]], type = 'scatter', mode = 'markers', color = ~ Rank, text = ~paste("Team: ", Squad, '<br>Year: ', Year), height = 400) |>
      layout(xaxis = list(title = "Possession"),
             yaxis = list(title = if (input$y2 == "Att.x")
                                     "Take-Ons Attempted"
                                  else if (input$y2 == "xA")
                                     "Expected Assists"
                                  else if (input$y2 == "PrgP")
                                     "Progressive Passes"
                                  else if (input$y2 == "Def 3rd")
                                     "Touches in Defensive Third"
                                  else if (input$y2 == "Mid 3rd")
                                     "Touches in Midfield Third"
                                  else if (input$y2 == "Att 3rd")
                                     "Touches in Attacking Third"
                                  else if (input$y2 == "prop_def_third")
                                     "Proption of Touches in Defensive Third"
                                  else if (input$y2 == "prop_mid_third")
                                     "Proportion of Touches in Midfield Third"
                                  else if (input$y2 == "prop_att_third")
                                     "Proportion of Touches in Attacking Third"
                                  ), title = "Effect of Passing and Possession Statistics on Average Possession")
  else if (!input$rank_pos1)
    if (input$d1 == "All Years")
    ps |>
       plot_ly(x = ~Poss, y = ~.data[[input$y2]], type = 'scatter', mode = 'markers', text = ~paste("Team: ", Squad, '<br>Year: ', Year), height = 400) |>
      layout(xaxis = list(title = "Possession"),
             yaxis = list(title = if (input$y2 == "Att.x")
                                     "Take-Ons Attempted"
                                  else if (input$y2 == "xA")
                                     "Expected Assists"
                                  else if (input$y2 == "PrgP")
                                     "Progressive Passes"
                                  else if (input$y2 == "Def 3rd")
                                     "Touches in Defensive Third"
                                  else if (input$y2 == "Mid 3rd")
                                     "Touches in Midfield Third"
                                  else if (input$y2 == "Att 3rd")
                                     "Touches in Attacking Third"
                                  else if (input$y2 == "prop_def_third")
                                     "Proption of Touches in Defensive Third"
                                  else if (input$y2 == "prop_mid_third")
                                     "Proportion of Touches in Midfield Third"
                                  else if (input$y2 == "prop_att_third")
                                     "Proportion of Touches in Attacking Third"
                                  ), title = "Effect of Passing and Possession Statistics on Average Possession")
    else 
       ps |>
    filter(Year %in% c(input$d1)) |>
       plot_ly(x = ~Poss, y = ~.data[[input$y2]], type = 'scatter', mode = 'markers', text = ~paste("Team: ", Squad, '<br>Year: ', Year), height = 400) |>
      layout(xaxis = list(title = "Possession"),
             yaxis = list(title = if (input$y2 == "Att.x")
                                     "Take-Ons Attempted"
                                  else if (input$y2 == "xA")
                                     "Expected Assists"
                                  else if (input$y2 == "PrgP")
                                     "Progressive Passes"
                                  else if (input$y2 == "Def 3rd")
                                     "Touches in Defensive Third"
                                  else if (input$y2 == "Mid 3rd")
                                     "Touches in Midfield Third"
                                  else if (input$y2 == "Att 3rd")
                                     "Touches in Attacking Third"
                                  else if (input$y2 == "prop_def_third")
                                     "Proption of Touches in Defensive Third"
                                  else if (input$y2 == "prop_mid_third")
                                     "Proportion of Touches in Midfield Third"
                                  else if (input$y2 == "prop_att_third")
                                     "Proportion of Touches in Attacking Third"
                                  ), title = "Effect of Passing and Possession Statistics on Average Possession")
})
```

```{r, echo = FALSE}
inputPanel(
  selectInput("third", label = "Third of Pitch",
              choices = c("Defensive Third" = "prop_def_third",
                          "Middle Third" = "prop_mid_third",
                          "Attacking Third" = "prop_att_third")), 
  selectInput("d2", "Year",
choices = c("All Years", unique(ps$Year))),
  sliderInput("pdt", label = "Proportion of Total Touches in Third",
              min = 0.1, max = 0.6, value = .32, step = .02)
)
renderPlot({
  if (input$d2 == "All Years")
  ps |>
    filter(.data[[input$third]] >= (input$pdt)) |>
    ggplot() +
    geom_point(aes(x = Poss, y = .data[[input$third]], color = Rank)) +
    labs(x = "Possession",
         y = switch(input$third,
                    "prop_def_third" = "Defensive Third",
                    "prop_mid_third" = "Middle Third",
                    "prop_att_third" = "Attacking Third"
), title = "Relationship Between Proportion of Touches in Third of Pitch and Overall Possession") +
    theme_clean()
  else 
  ps |>
    filter(Year %in% c(input$d2)) |>
    filter(.data[[input$third]] >= (input$pdt)) |>
    ggplot() +
    geom_point(aes(x = Poss, y = .data[[input$third]], color = Rank)) +
      labs(x = "Possession", title = "Relationship Between Proportion of Touches in Third of Pitch and Overall Possession") +
    theme_clean()
}, height = 400)
```

Column
---------------------------

```{r, echo = FALSE}
inputPanel(
  selectInput("y1", label = "Y-Axis Variable",
              choices = c(
                           "Take-Ons Attempted per Match" = "takeons_attempted_90",
                          "Progressive Passes per Match" = "PrgP_90",
                          "Touches in Defensive Third per Match" = "def_third_touches_90", 
                          "Touches in Midfield Third per Match" = "mid_third_touches_90",
                          "Touches in Attacking Third per Match" = "att_third_touches_90",
                          "Progressive Carries per Match" = "PrgC_90",
                          "Pass Completion %" = "Cmp%",
                          "Crosses per Match" = "crosses_90",
                          "Key Passes per Match" = "kp_90",
                          "Possession" = "Poss"))
)

renderPlot({
  ggplot(ps, aes(x = Rank, y = .data[[input$y1]])) +
    geom_boxplot() +
    scale_x_discrete(limits = c("GR", "R16", "QF", "SF", "F", "W")) +
    labs(y = switch(input$y1,
                    "takeons_attempted_90" = "Take-Ons Attempted per Match",
                    "PrgP_90" = "Progressive Passes per Match",
                    "def_third_touches_90" = "Touches in Defensive Third per Match", 
                    "mid_third_touches_90" = "Touches in Midfield Third per Match",
                    "att_third_touches_90" = "Touches in Attacking Third per Match",
                    "PrgC_90" = "Progressive Carries per Match",
                    "Cmp%" = "Pass Completion %",
                    "crosses_90" = "Crosses per Match",
                    "kp_90" = "Key Passes per Match", 
                    "Poss" = "Possession"), title = "Passing and Possession Statistical Averages by Champions League Placement") +
    theme_clean()
}, height = 400)
```


*Commentary:*

Generally, higher attacking-minded passing/possession statistics (expected assists, touches in attacking third, progressive passes/carries) translate to better performance in the Champions League. This makes sense, as better performing teams are (1) likely to score more goals and (2) have more attacking output due to having higher overall possession and player more adept at creating goal-scoring opportunities. This is also supported by the trends in proportion of touches in specific thirds of the field. From the graph in the bottom left, we see a negative trend in proportion of touches in defensive third and possession so, thus, a negative correlation between touches in the defensive third and performance. Year after year, we see lesser teams rely on long balls and set pieces opportunities to create goal-scoring opportunities opposed to maintaining possession and progressing the ball upfield, so this finding makes sense. 


```{r, echo = FALSE}
inputPanel(
  selectInput("yr2", "Year",
choices = c("All Years", unique(gs$Year))),
)

renderPlot({
  if (input$yr2 == "All Years")
    ps |>
    ggplot(aes(x = `A-xAG`)) +
    geom_density() +
    labs(x = "Assists minus Expected Goals Assisted", y = "Proportion of Teams", title = "Distribution of Assists Minus Expected Assists Values") +
    theme_clean()
  else
    ps |>
      filter(Year %in% c(input$yr2)) |>
      ggplot(aes(x = `A-xAG`)) +
      geom_density() +
    labs(x = "Assists minus Expected Goals Assisted", y = "Proportion of Teams", title = "Distribution of Assists Minus Expected Assists Values") +
    theme_clean()
}, height = 400)
```


Defending and Goalkeeping
================================

Column
-------------

```{r, echo = FALSE}
titlePanel("Defensive Metrics")

inputPanel(
  selectInput("dsv", label = "Y-Axis Variable",
              choices = c(
                          "Save Percentage" = "Save%",
                          "Shots on Target Against" = "SoTA",
                          "Expected Goals Conceded" = "PSxG",
                          "Expected Goals Conceded minus Goals Allowed" = "PSxG+/-",
                          "Crosses Faced" = "Opp", 
                          "Tackles Won" = "TklW",
                          "Interceptions" = "Int",
                          "Blocks (Shots + Passes)" = "Blocks")),
  selectInput("d3", label = "Year",
  choices = c("All Years", unique(ds$Year))),
checkboxInput("rank_pos2", "Show Final Placement", value = FALSE)
)

ds$Rank <- factor(ds$Rank, levels = legend_order)

renderPlotly({
   if (input$rank_pos2) 
    if (input$d3 == "All Years")
    ds |>
  plot_ly(x = ~GA90, y = ~.data[[input$dsv]], type = 'scatter', mode = 'markers', color = ~ Rank, text = ~paste("Team: ", Squad, '<br>Year: ', Year), height = 400) |>
    layout(legend = list(c("W", "F", "SF", "QF", "R16", "GR")),
           xaxis = list(title = "Goals Against per 90 minutes"),
           yaxis = list(title = if (input$dsv == "Save%")
                                     "Save Percentage"
                                  else if (input$dsv == "SoTA")
                                     "Shots on Target Against"
                                  else if (input$dsv == "PSxG")
                                     "Expected Goals Conceded"
                                  else if (input$dsv == "PSxG+/-")
                                     "Expected Goals Conceded minus Goals Allowed"
                                  else if (input$dsv == "Opp")
                                     "Crosses Faced"
                                  else if (input$dsv == "TklW")
                                     "Tackles Won"
                                  else if (input$dsv == "Int")
                                     "Interceptions"
                                  else if (input$dsv == "Blocks")
                                     "Blocks (Shots + Passes)"
                                  ), title = "Effect of Defensive Statistics on Goals Allowed per 90 Minutes")
    else 
       ds |>
    filter(Year %in% c(input$d3)) |>
   plot_ly(x = ~GA90, y = ~.data[[input$dsv]], type = 'scatter', mode = 'markers', color = ~ Rank, text = ~paste("Team: ", Squad, '<br>Year: ', Year), height = 400) |>
  layout(legend = list(c("W", "F", "SF", "QF", "R16", "GR")),
           xaxis = list(title = "Goals Against per 90 minutes"),
         yaxis = list(title = if (input$dsv == "Save%")
                                     "Save Percentage"
                                  else if (input$dsv == "SoTA")
                                     "Shots on Target Against"
                                  else if (input$dsv == "PSxG")
                                     "Expected Goals Conceded"
                                  else if (input$dsv == "PSxG+/-")
                                     "Expected Goals Conceded minus Goals Allowed"
                                  else if (input$dsv == "Opp")
                                     "Crosses Faced"
                                  else if (input$dsv == "TklW")
                                     "Tackles Won"
                                  else if (input$dsv == "Int")
                                     "Interceptions"
                                  else if (input$dsv == "Blocks")
                                     "Blocks (Shots + Passes)"
                                  ), title = "Effect of Defensive Statistics on Goals Allowed per 90 Minutes")
  else if (!input$rank_pos2)
    if (input$d3 == "All Years")
    ds |>
       plot_ly(x = ~GA90, y = ~.data[[input$dsv]], type = 'scatter', mode = 'markers', text = ~paste("Team: ", Squad, '<br>Year: ', Year), height = 400) |>
  layout(legend = list(c("W", "F", "SF", "QF", "R16", "GR")),
           xaxis = list(title = "Goals Against per 90 minutes"),
           yaxis = list(title = if (input$dsv == "Save%")
                                     "Save Percentage"
                                  else if (input$dsv == "SoTA")
                                     "Shots on Target Against"
                                  else if (input$dsv == "PSxG")
                                     "Expected Goals Conceded"
                                  else if (input$dsv == "PSxG+/-")
                                     "Expected Goals Conceded minus Goals Allowed"
                                  else if (input$dsv == "Opp")
                                     "Crosses Faced"
                                  else if (input$dsv == "TklW")
                                     "Tackles Won"
                                  else if (input$dsv == "Int")
                                     "Interceptions"
                                  else if (input$dsv == "Blocks")
                                     "Blocks (Shots + Passes)"
                                  ), title = "Effect of Defensive Statistics on Goals Allowed per 90 Minutes")
    else 
       ds |>
    filter(Year %in% c(input$d3)) |>
       plot_ly(x = ~GA90, y = ~.data[[input$dsv]], type = 'scatter', mode = 'markers', text = ~paste("Team: ", Squad, '<br>Year: ', Year), height = 400) |>
       layout(legend = list(c("W", "F", "SF", "QF", "R16", "GR")),
           xaxis = list(title = "Goals Against per 90 minutes"),
           yaxis = list(title = if (input$dsv == "Save%")
                                     "Save Percentage"
                                  else if (input$dsv == "SoTA")
                                     "Shots on Target Against"
                                  else if (input$dsv == "PSxG")
                                     "Expected Goals Conceded"
                                  else if (input$dsv == "PSxG+/-")
                                     "Expected Goals Conceded minus Goals Allowed"
                                  else if (input$dsv == "Opp")
                                     "Crosses Faced"
                                  else if (input$dsv == "TklW")
                                     "Tackles Won"
                                  else if (input$dsv == "Int")
                                     "Interceptions"
                                  else if (input$dsv == "Blocks")
                                     "Blocks (Shots + Passes)"
                                  ), title = "Effect of Defensive Statistics on Goals Allowed per 90 Minutes")
})
```

```{r, echo = FALSE}
inputPanel(
  selectInput("x_var", label = "X-Axis Variable",
              choices = c(
                          "Proportion Tackles Won" = "prop_tkl_w",
                          "Percent of Dribblers Tackled" = "Tkl%",
                          "Challenges Lost" = "Lost",
                          "Shots Blocked" = "Sh",
                          "Interceptions" = "Int", 
                          "Errors" = "Err"))
)

renderPlot({
  ggplot(ds, aes(.data[[input$x_var]], Squad)) +
    geom_line(aes(group = Squad)) +
    geom_point(aes(color = save_performance)) +
    labs(color = "Save Performance", x = switch(input$x_var,
                    "prop_tkl_w" = "Proportion Tackles Won",
                    "Tkl%" = "Percent of Dribblers Tackled",
                    "Lost" = "Challenges Lost",
                    "Sh" = "Shots Blocked",
                    "Int" = "Interceptions",
                    "Err" = "Errors"), 
         title = "Relationship Between Save Performance and Various Defensive Statistics", subtitle = "Data includes all teams that played in Champions League between 2018-2023") +
    theme_clean()
},
height = 1000)
```

Column
----------

```{r, echo = FALSE}
inputPanel(
  selectInput("dsv1", label = "Y-Axis Variable",
              choices = c(
                          "Goals Allowed per 90 Minutes" = "GA90",
                          "Save Percentage" = "Save%",
                          "Post-Shot Expected Goals" = "PSxG",
                          "Post-Shot Expected Goals - Goals Allowed" = "PSxG+/-",
                          "Crossed Attempted Against per Match" = "opp_90", 
                          "Tackles per Match" = "tkl_90",
                          "Interceptions per Match" = "int_90",
                          "Tackles + Interceptions per Match" = "tkl_int_90",
                          "Tackles in Defensive Third per Match" = "def_3rd_90",
                      "Tackles in Attacking Third per Match" = "att_3rd_90"))
)

renderPlot({
  ggplot(ds, aes(x = Rank, y = .data[[input$dsv1]])) +
    geom_boxplot() +
    scale_x_discrete(limits = c("GR", "R16", "QF", "SF", "F", "W")) +
    labs(y = switch(input$dsv1,
                    "GA90" = "Goals Allowed per 90 Minutes",
                    "Save%" = "Save Percentage",
                    "PSxG" = "Post-Shot Expected Goals",
                    "PSxG+/-" = "Post-Shot Expected Goals - Goals Allowed",
                    "opp_90" = "Crossed Attempted Against per Match", 
                    "tkl_90" = "Tackles per Match",
                    "int_90" = "Interceptions per Match",
                    "tkl_int_90" = "Tackles + Interceptions per Match",
                    "def_3rd_90" = "Tackles in Defensive Third per Match",
                    "att_3rd_90" = "Tackles in Attacking Third per Match"), title = "Defensive Statistical Averages by Champions League Placement") +
    theme_clean()
})
```

```{r, echo = FALSE}
inputPanel(
  selectInput("yr3", "Year",
choices = c("All Years", unique(gs$Year))),
checkboxInput("ninety", "Per 90 Minutes", value = FALSE)
)

renderPlot({
  if(!input$ninety)
    if (input$yr3 == "All Years")
      ds |>
      ggplot(aes(x = `PSxG+/-`)) +
      geom_density() +
      labs(x = "Post-Shot Expected Goals minus Goals Allowed", y = "Proportion of Teams", title = "Distribution of Post-Shot Expected Goals Minus Goals Allowed (Total or per 90 Minutes)") +
    theme_clean()
    else
      ds |>
        filter(Year %in% c(input$yr3)) |>
        ggplot(aes(x = `PSxG+/-`)) +
        geom_density() +
      labs(x = "Post-Shot Expected Goals minus Goals Allowed", y = "Proportion of Teams", title = "Distribution of Post-Shot Expected Goals Minus Goals Allowed (Total or per 90 Minutes)") +
    theme_clean()
  else
    if (input$yr3 == "All Years")
      ds |>
      ggplot(aes(x = `/90`)) +
      geom_density() +
      labs(x = "Post-Shot Expected Goals minus Goals Allowed per 90 Minutes", y = "Proportion of Teams", title = "Distribution of Post-Shot Expected Goals Minus Goals Allowed (Total or per 90 Minutes)") +
    theme_clean()
    else
      ds |>
        filter(Year %in% c(input$yr3)) |>
        ggplot(aes(x = `/90`)) +
        geom_density() +
      labs(x = "Post-Shot Expected Goals minus Goals Allowed per 90 Minutes", y = "Proportion of Teams", title = "Distribution of Post-Shot Expected Goals Minus Goals Allowed (Total or per 90 Minutes)") +
    theme_clean()
})
```


*Commentary:*

Naturally, it makes sense that goals conceded (and similar metrics) is positively correlated with performance: if you concede less goals, you're going to win more games. However, many per match defensive statistics produced interest results. For instance, tackles and interceptions per match is negatively correlated. While, at first, you might assume that higher performing teams will have greater numbers of defensive actions, a deeper analysis changes this narrative. As, seen by possession statistics, higher performing teams have more of the ball, there is less opportunity for better performing teams to tackle and intercept the ball as they have more of it and, more often than not, team's going against them will often give the ball away on their own. Our Cleveland Dotplot measuring the relationship between proportion of tackles won and save performance produced interesting results in that there is little correlation between the two variables. While, yes, winning a higher proportion of tackles does suggest better defensive performance, a multitude of over factor influence the shots conceded by a team, meaning we must create more visualizations to find out what influences over or under performance.

Summarization
================================

Column
-------------

```{r, echo = FALSE}
inputPanel(
  selectInput("yr4", "Year",
choices = c("22/23" = "22/23", "21/22" = "21/22", "20/21" = "20/21", "19/20" = "19/20", "18/19" = "18/19")))

renderPlotly({
total_s |>
  select(Squad, Year, xG, SCA90, `SoT/90`, Dist, xAG, kp_90, takeons_attempted_90, PrgC_90, SoTA, PSxG, tkl_int_90, opp_90) |>
  filter(Year %in% c(input$yr4)) |>
  select(!Year) |>
 melt(id.vars = "Squad") |>
plot_ly(
  y = ~Squad, 
  x = ~variable,
  z = ~value,
  type = "heatmap",
  height = 750) |>
  layout(xaxis = list(title = ""), zaxis = list(title = "Value"), title = "Overall Statistical Performance by Team")
})
```

------------
------------
```{r}
renderTable({
  total_s |>
    select(Squad, Rank, Year) |>
    filter(Year %in% c(input$yr4)) |>
    gt()
})
```


Conclusion
================================

Column
---------------------------

With an unprecedented amount of metrics measuring every aspect of a match, it is challenging to single out certain statistics that influence soccer matches. However, thanks to Football Reference's detailed database, we have been able to tell of story how a team's performance in the Champions League is influenced by a variety of variables. In our analysis, a few trends become clear. First, team's that win create goal-scoring opportunities, lots of goal-scoring opportunities. Whether it be seen through key passes, progressive carries, or expected goals and assists metrics, the very best teams are masters at creating opportunities in front of goal. One of the most interesting trends in our data is that higher-placing teams often have lower per-90 totals for defensive statistics. Actions such as tackles, interceptions, and expected goals allowed are consistently lower for the best teams in the Champions League. As mentioned in prior analysis, this can be attributed to the fact that better teams are forced to defend less, but this finding still provides valuable information in how to interpret defensive statistics. Our biggest takeaway, however, is that telling a story of Champions League performance is dependent on a variety of variables across different aspects of the game. Goal creation, possession, defense, and goalkeeping are all necessary statistical categories for creating a holistic analysis of what impacts a team's performance in the UEFA Champions League. But with soccer experiencing an ongoing data revolution, there is no shortage of statistics.

The goal of this project was to perform various forms of analytics on different types of statistics in three distinct areas. We wanted to do this for the champions league seasons for the past five years. In order to do this, we took a look at seven different tables for each season and joined a few of them together in order to end up with our three categories. For the shooting portion of the project we combined the Goal and Shot Creation and the shooting datasets. For The Possession statistics we combined the Possession and Passing tables. Finally, for the Defense and Goalkeeping portion we combined the Defensive Actions, Goalkeeping, and Advanced Goalkeeping data. All of these seven tables can be found under the Squad and Player Stats dropdown for each year. Once we acquired the data and combined them we ended up making our own variables for further analysis.

Acquiring this data was pretty straight forward since all of these tables are already in nice table format. We just had to use rvest to grab each of the seven datasets for each of the five years. Although it wasn't a very annoying process since we were given nice tables, this was a ton of datasets to get our hands on, so it was quite a long process. Once we obtained this data, there wasn't too much to change, but there were a few things. For one we had to change all the variable names since they were in the first row of the dataset at first for some reason. We then fixed up the squad names since they were imported with their country name and squad name, so we used some text analysis to remove the countries since that was not our focus. We then had everything we needed except for the year of that squad playing so we added those in ourselves.

Overall, once we had the data we needed along with all the variables we made, making the plots we needed to was not the biggest struggle since our data was nice, but manipulating it to work with our flexdashboard through shiny was tough in many cases. In particular, the most difficult parts were first trying to get the labels of the variables that are changed using the dropdowns we made. The other part that was a pain was getting our plotly scatterplots to work especially with those axis labels, but once everything was laid out and complete in the form we have here it was definitely a pain worth going through since this was a very fun project for both of us!






One of the teams to the right will win the Champions League in 2025 :)

Column
---------------------------

```{r, echo=FALSE}
renderImage({
    # Return a list
    list(src = "Arsenal_FC.svg.png",
         alt = "This is alternate text", width = 600, height = 700)
  })
```

```{r, echo=FALSE}
renderImage({
    # Return a list
    list(src = "transparent.png",
         alt = "This is alternate text", width = 600, height = 600)
  })
```

```{r, echo=FALSE}
renderImage({
    # Return a list
    list(src = "Liverpool_FC.svg",
         alt = "This is alternate text", width = 600, height = 600)
  })
```




