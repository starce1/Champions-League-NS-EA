---
title: "Champions League Progression"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    theme: 
      version: 3
      primary: "#ED79F9"
      navbar-bg: "#b59736"
      base_font: 
        google: Prompt
      heading_font:
        google: Sen
      code_font:
        google: 
          # arguments to sass::font_google() 
          family: JetBrains Mono
          local: false
    logo: 
---

```{r}
#bg: "#008c45"
#fg: "#02a452"
```


```{r, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(stringr)
library(rvest)
library(httr)
library(ggplot2)
library(readr)
library(plotly)
library(flexdashboard)
library(ggthemes)
library(shinyWidgets)
```

```{r, echo = FALSE}
gs <- read_csv("gs.csv")
ps <- read_csv("ps.csv")
ds <- read_csv("ds.csv")
```

About
==========================

Column {data-width = 400}
-------------------------

#### Background Information

In this Shiny app, we investigate many of the subtle variables of that affect the outcome of a soccer game. Using the UFEA Champions League statistics from the 2018-2023 seasons, we compare certain skills in different game situation throughout time.

Data source:  [FBREF Database](https://fbref.com/en/comps/8/history/Champions-League-Seasons)

[UFEA Champions League Official Website](https://www.uefa.com/uefachampionsleague/)

```{r, echo=FALSE}

renderImage({
    # Return a list
    list(src = "UEFA_Champions_League.svg.png",
         alt = "This is alternate text", width = 600, height = 600)
  })
```

Goals
=========================

Column
---------------------------

```{r, echo = FALSE}
titlePanel("Goal Metrics") 

inputPanel(
  selectInput("y", label = "Y-Axis Variable",
              choices = c(
                          "Expected Goals" = "xG",
                          "Non-Penalty Expected Goals" = "npxG",
                          "Average Shot Distance" = "Dist",
                          "Shots per 90 Minutes" = "Sh/90",
                          "Shot on Target %" = "SoT%", 
                          "Shot Creation Actions per 90 Minutes" = "SCA90",
                          "Proportion of Shot Creating Actions from Dead Balls" = "prop_SCA_dead")),
  selectInput("d", label = "Year",
  choices = c("All Years", unique(gs$Year))),
checkboxInput("rank_pos", "Show Final Placement", value = FALSE)
)

renderPlot({
  if (input$rank_pos) 
    if (input$d == "All Years")
    gs |>
    ggplot(aes(x = Gls, y = .data[[input$y]])) +
    geom_point(aes(color = Rank)) +
    geom_smooth(method = lm, se = FALSE, color = "Black") +
    scale_color_discrete(limits = c("W", "F", "SF", "QF", "R16", "GR"))
    else 
    gs |>
    filter(Year %in% c(input$d)) |>
    ggplot(aes(x = Gls, y = .data[[input$y]])) +
    geom_point(aes(color = Rank)) +
    geom_smooth(method = lm, se = FALSE, color = "Black") +
    scale_color_discrete(limits = c("W", "F", "SF", "QF", "R16", "GR")) 
  else if (!input$rank_pos)
    if (input$d == "All Years")
    gs |>
      ggplot(aes(x = Gls, y = .data[[input$y]])) +
    geom_point() +
    geom_smooth(method = lm, se = FALSE, color = "Black") +
    scale_color_discrete(limits = c("W", "F", "SF", "QF", "R16", "GR"))
    else 
      gs |>
    filter(Year %in% c(input$d)) |>
       ggplot(aes(x = Gls, y = .data[[input$y]])) +
    geom_point() +
    geom_smooth(method = lm, se = FALSE, color = "Black") +
    scale_color_discrete(limits = c("W", "F", "SF", "QF", "R16", "GR"))
})
```

```{r, echo = FALSE}
renderPlot({
  if (input$d == "All Years")
gs |>
ggplot() +
  geom_bar(aes(x = Rank, fill = performance)) +
  scale_x_discrete(limits = c("W", "F", "SF", "QF", "R16", "GR"))
  else 
  gs |>
    filter(Year %in% c(input$d)) |>
ggplot() +
  geom_bar(aes(x = Rank, fill = performance)) +
  scale_x_discrete(limits = c("W", "F", "SF", "QF", "R16", "GR"))
})
```

Column
---------------------------

```{r, echo = FALSE}
inputPanel(
  selectInput("y3", label = "Y-Axis Variable",
              choices = c(
                          "Expected Goals" = "xG",
                          "Goals" = "Gls",
                          "Non-Penalty Expected Goals" = "npxG",
                          "Average Shot Distance" = "Dist",
                          "Shots per 90 Minutes" = "Sh/90",
                          "Shot on Target %" = "SoT%", 
                          "Shot Creation Actions per 90 Minutes" = "SCA90",
                          "Proportion of Shot Creating Actions from Dead Balls" = "prop_SCA_dead"))
)

renderPlot({
  ggplot(gs, aes(x = Rank, y = .data[[input$y3]])) +
    geom_boxplot() +
    scale_x_discrete(limits = c("GR", "R16", "QF", "SF", "F", "W"))
})
```


Possession
=========================

Column
---------------------------

```{r, echo = FALSE}
titlePanel("Possession and Passing Metrics") 
inputPanel(
  selectInput("y2", label = "Y-Axis Variable",
              choices = c(
                          "Take-Ons Attempted" = "Att.x",
                          "Expected Assists" = "xA",
                          "Progressive Passes" = "PrgP",
                          "Touches in Defensive Third" = "Def 3rd", 
                          "Touches in Midfield Third" = "Mid 3rd",
                          "Touches in Attacking Third" = "Att 3rd",
                          "Proption of Touches in Defensive Third" = "prop_def_third",
                          "Proportion of Touches in Midfield Third" = "prop_mid_third",
                          "Proportion of Touches in Attacking Third" = "prop_att_third")),
  selectInput("d", label = "Year",
  choices = c("All Years", unique(ps$Year))),
checkboxInput("rank_pos", "Show Final Placement", value = FALSE)
)

renderPlot({
  if (input$rank_pos) 
    if (input$d == "All Years")
    ps |>
  ggplot(aes(x = Poss, y = .data[[input$y2]])) +
    geom_point(aes(color = Rank)) +
    geom_smooth(method = lm, se = FALSE, color = "Black") +
    scale_color_discrete(limits = c("W", "F", "SF", "QF", "R16", "GR"))
    else 
       ps |>
    filter(Year %in% c(input$d)) |>
  ggplot(aes(x = Poss, y = .data[[input$y2]])) +
    geom_point(aes(color = Rank)) +
    geom_smooth(method = lm, se = FALSE, color = "Black") +
    scale_color_discrete(limits = c("W", "F", "SF", "QF", "R16", "GR"))
  else if (!input$rank_pos)
    if (input$d == "All Years")
    ps |>
      ggplot(aes(x = Poss, y = .data[[input$y2]])) +
    geom_point() +
    geom_smooth(method = lm, se = FALSE, color = "Black") +
    scale_color_discrete(limits = c("W", "F", "SF", "QF", "R16", "GR"))
    else 
       ps |>
    filter(Year %in% c(input$d)) |>
      ggplot(aes(x = Poss, y = .data[[input$y2]])) +
    geom_point() +
    geom_smooth(method = lm, se = FALSE, color = "Black") +
    scale_color_discrete(limits = c("W", "F", "SF", "QF", "R16", "GR"))
})
```

Column
---------------------------

```{r, echo = FALSE}
inputPanel(
  selectInput("y1", label = "Y-Axis Variable",
              choices = c(
                          "Take-Ons Attempted" = "Att.x",
                          "Expected Assists" = "xA",
                          "Progressive Passes" = "PrgP",
                          "Possession" = "Poss",
                          "Touches in Defensive Third" = "Def 3rd", 
                          "Touches in Midfield Third" = "Mid 3rd",
                          "Touches in Attacking Third" = "Att 3rd",
                          "Take-Ons Per Match" = "takeons_per_match",
                          "Proption of Touches in Defensive Third" = "prop_def_third"))
)

renderPlot({
  ggplot(ps, aes(x = Rank, y = .data[[input$y1]])) +
    geom_boxplot() +
    scale_x_discrete(limits = c("GR", "R16", "QF", "SF", "F", "W"))
})
```

Column
--------------------------

```{r, echo = FALSE}
inputPanel(
  selectInput("third", label = "Third of Pitch",
              choices = c("Defensive Third" = "prop_def_third",
                          "Middle Third" = "prop_mid_third",
                          "Attacking Third" = "prop_att_third")), 
  selectInput("d", "Year",
choices = c("All Years", unique(ps$Year))),
  sliderInput("pdt", label = "Proportion of Total Touches in Third",
              min = 0.1, max = 0.6, value = .32, step = .02)
)

renderPlot({
  if (input$d == "All Years")
  ps |>
    filter(.data[[input$third]] >= (input$pdt)) |>
    ggplot() +
    geom_point(aes(x = Poss, y = .data[[input$third]], color = Rank)) +
    labs(x = "Possession") +
    theme_clean()
  else 
  ps |>
    filter(Year %in% c(input$d)) |>
    filter(.data[[input$third]] >= (input$pdt)) |>
    ggplot() +
    geom_point(aes(x = Poss, y = .data[[input$third]], color = Rank)) +
      labs(x = "Possession") +
    theme_clean()
})
```

Defending and Goalkeeping
================================

Column
-------------

```{r, echo = FALSE}
titlePanel("Defensive Metrics")

inputPanel(
  selectInput("dsv", label = "Y-Axis Variable",
              choices = c(
                          "Save Percentage" = "Save%",
                          "Shots on Target Against" = "SoTA",
                          "Expected Goals Conceded" = "PSxG",
                          "Expected Goals Conceded minus Goals Allowed" = "PSxG+/-",
                          "Crosses Faced" = "Opp", 
                          "Tackles Won" = "TklW",
                          "Interceptions" = "Int",
                          "Blocks (Shots + Passes)" = "Blocks")),
  selectInput("d", label = "Year",
  choices = c("All Years", unique(ds$Year))),
checkboxInput("rank_pos", "Show Final Placement", value = FALSE)
)
renderPlot({
  if (input$rank_pos) 
    if (input$d == "All Years")
    ds |>
  ggplot(aes(x = GA90, y = .data[[input$dsv]])) +
    geom_point(aes(color = Rank)) +
    geom_smooth(method = lm, se = FALSE, color = "Black") +
    scale_color_discrete(limits = c("W", "F", "SF", "QF", "R16", "GR"))
    else 
    ds |>
    filter(Year %in% c(input$d)) |>
  ggplot(aes(x = GA90, y = .data[[input$dsv]])) +
    geom_point(aes(color = Rank)) +
    geom_smooth(method = lm, se = FALSE, color = "Black") +
    scale_color_discrete(limits = c("W", "F", "SF", "QF", "R16", "GR"))
  else if (!input$rank_pos)
    if (input$d == "All Years")
    ds |>
      ggplot(aes(x = GA90, y = .data[[input$dsv]])) +
    geom_point() +
    geom_smooth(method = lm, se = FALSE, color = "Black") +
    scale_color_discrete(limits = c("W", "F", "SF", "QF", "R16", "GR"))
    else 
      ds |>
    filter(Year %in% c(input$d)) |>
      ggplot(aes(x = GA90, y = .data[[input$dsv]])) +
    geom_point() +
    geom_smooth(method = lm, se = FALSE, color = "Black") +
    scale_color_discrete(limits = c("W", "F", "SF", "QF", "R16", "GR"))
})
```